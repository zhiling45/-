<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>è´ªåƒè›‡ Â· å½©è‰²è±ªåç‰ˆ</title>
<style>
:root{
  --bg:#0b1220; --panel:#111827; --line:#263246; --fg:#e5e7eb;
  --accent:#7c3aed; --ok:#22c55e; --warn:#f59e0b; --cool:#38bdf8; --bad:#ef4444;
}
*{box-sizing:border-box}
body{
  margin:0; background: radial-gradient(1000px 600px at 10% -10%, #1d2640 0%, #0b1220 40%, #090f1a 100%);
  color:var(--fg); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Microsoft YaHei", Arial, sans-serif;
  min-height:100vh; display:grid; place-items:center; padding:16px;
}
.wrap{width:100%; max-width:620px; display:grid; gap:12px}
.top{display:flex; justify-content:space-between; align-items:center; gap:8px}
h1{margin:0; font-size:20px; letter-spacing:.5px}
.stats{display:flex; gap:8px; flex-wrap:wrap}
.pill{border:1px solid #334155; padding:4px 10px; border-radius:999px; background:rgba(17,24,39,.6); backdrop-filter: blur(4px); font-size:13px}
.btn{
  border:1px solid #475569; background:linear-gradient(180deg,#111827,#0f172a); color:var(--fg);
  padding:8px 12px; border-radius:12px; cursor:pointer;
}
.btn:hover{border-color:var(--accent)}
.board{
  position:relative; border:1px solid #334155; border-radius:16px; overflow:hidden;
  background: radial-gradient(900px 500px at 80% -20%, rgba(124,58,237,.15), transparent),
              radial-gradient(900px 500px at 20% 120%, rgba(56,189,248,.12), transparent),
              #020617;
}
canvas{width:100%; aspect-ratio:1; display:block; touch-action:none}
.controls{display:grid; grid-template-columns:repeat(3,1fr); gap:8px}
.pad{background:#0f172a; border:1px solid #334155; border-radius:12px; padding:16px; text-align:center; font-weight:700}
.pad:active{transform:scale(.98); border-color:var(--accent)}
.legend{display:flex; gap:8px; flex-wrap:wrap; font-size:12px; opacity:.9}
.dot{width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:6px; vertical-align:-1px}
footer{opacity:.6; text-align:center; font-size:12px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h1>ğŸŒˆ è´ªåƒè›‡ Â· å½©è‰²è±ªåç‰ˆ</h1>
      <div>
        <button class="btn" id="btnPause">æš‚åœ</button>
        <button class="btn" id="btnRestart">é‡å¼€</button>
      </div>
    </div>

    <div class="top">
      <div class="stats">
        <div class="pill">åˆ†æ•° <span id="score">0</span></div>
        <div class="pill">æœ€é«˜ <span id="best">0</span></div>
        <div class="pill">ç­‰çº§ <span id="level">1</span></div>
        <div class="pill">é€Ÿåº¦ <span id="speed">1x</span></div>
      </div>
      <div class="legend">
        <span><i class="dot" style="background:#22c55e"></i>æ™®é€š</span>
        <span><i class="dot" style="background:#f59e0b"></i>â­åŠ åˆ†</span>
        <span><i class="dot" style="background:#38bdf8"></i>â„å‡é€Ÿ</span>
        <span><i class="dot" style="background:#ef4444"></i>éšœç¢</span>
      </div>
    </div>

    <div class="board"><canvas id="c" width="540" height="540"></canvas></div>

    <div class="controls" id="touchCtrls">
      <div></div><button class="pad" data-d="up">â†‘</button><div></div>
      <button class="pad" data-d="left">â†</button>
      <button class="pad" data-d="down">â†“</button>
      <button class="pad" data-d="right">â†’</button>
      <div></div><button class="pad" id="padPause">æš‚åœ/ç»§ç»­</button><div></div>
    </div>

    <footer>é”®ç›˜ï¼šâ†‘â†“â†â†’ æˆ– WASDï¼›P æš‚åœï¼›R é‡å¼€ï¼›æ‰‹æœºæ”¯æŒæ»‘åŠ¨</footer>
  </div>

<script>
(()=>{
// ===== åŸºæœ¬å‚æ•° =====
const GRID = 24;               // 24x24
const CELL = 22;               // åƒç´ 
const W = GRID*CELL, H = GRID*CELL;
const BASE_TICK = 115;         // åŸºç¡€é€Ÿåº¦ï¼ˆæ¯«ç§’è¶Šå°è¶Šå¿«ï¼‰
const LVL_STEP = 8;            // æ¯ LVL_STEP åˆ†åŠ ä¸€å…³
const MAX_SPEED_MUL = 7;

const cv = document.getElementById('c');
const ctx = cv.getContext('2d');
const $ = id => document.getElementById(id);

let best = +localStorage.getItem('snake_best_rich') || 0;
$('best').textContent = best;

let state;

// ===== å·¥å…·å‡½æ•° =====
const randInt = n => (Math.random()*n)|0;
const eq = (a,b)=>a.x===b.x && a.y===b.y;
const inSnake = (p)=> state.snake.some(s=>eq(s,p));
const inObst  = (p)=> state.obstacles.some(o=>eq(o,p));
function freeSpot(){
  while(true){
    const p={x:randInt(GRID), y:randInt(GRID)};
    if(!inSnake(p) && !inObst(p)) return p;
  }
}
function wrap(val, max){ return (val+max)%max; }

// å½©è™¹é¢œè‰²
function rainbow(i, total, a=1){
  const t = (i/total);
  const r = Math.floor(255*Math.abs(Math.sin(Math.PI*t)));
  const g = Math.floor(255*Math.abs(Math.sin(Math.PI*(t+.33))));
  const b = Math.floor(255*Math.abs(Math.sin(Math.PI*(t+.66))));
  return `rgba(${r},${g},${b},${a})`;
}

// ç²’å­ç³»ç»Ÿï¼ˆåƒåˆ°é£Ÿç‰©æ—¶ï¼‰
const particles=[];
function spawnParticles(p, color){
  for(let i=0;i<10;i++){
    particles.push({
      x:p.x*CELL+CELL/2, y:p.y*CELL+CELL/2, vx:(Math.random()-0.5)*3, vy:(Math.random()-0.5)*3,
      life:18, color
    });
  }
}
function drawParticles(){
  for(let i=particles.length-1;i>=0;i--){
    const P=particles[i]; P.x+=P.vx; P.y+=P.vy; P.life--;
    ctx.fillStyle=P.color.replace('1)', (P.life/18).toFixed(2)+')');
    ctx.fillRect(P.x, P.y, 3, 3);
    if(P.life<=0) particles.splice(i,1);
  }
}

// ===== æ¸¸æˆçŠ¶æ€ä¸æ§åˆ¶ =====
function reset(){
  state = {
    snake: [{x:12,y:12},{x:11,y:12},{x:10,y:12}],
    dir: {x:1,y:0}, next: {x:1,y:0},
    food: spawnFood('normal'),
    bonus: null,
    slow: null,
    obstacles: [],
    score:0, level:1, speedMul:1,
    freezeTick:0,
    running:true, tickCnt:0, elapsed:0
  };
  // åˆå§‹éšœç¢
  addObstacles(4);
  updateUI();
}
function updateUI(){
  $('score').textContent = state.score;
  $('level').textContent = state.level;
  $('speed').textContent = state.speedMul+'x';
  $('btnPause').textContent = state.running ? 'æš‚åœ' : 'ç»§ç»­';
  $('padPause').textContent = state.running ? 'æš‚åœ/ç»§ç»­' : 'ç»§ç»­/æš‚åœ';
}

function addObstacles(n){
  for(let i=0;i<n;i++){
    const p = freeSpot();
    state.obstacles.push(p);
  }
}

function spawnFood(kind='normal'){
  const p = freeSpot();
  return {kind, pos:p, ttl: kind==='bonus'? 600: null};
}

// ===== è¾“å…¥å¤„ç† =====
function turn(x,y){
  if(x === -state.dir.x && y === -state.dir.y) return;
  state.next = {x,y};
}
window.addEventListener('keydown',e=>{
  const k=e.key.toLowerCase();
  if(k==='arrowup'||k==='w') turn(0,-1);
  if(k==='arrowdown'||k==='s') turn(0,1);
  if(k==='arrowleft'||k==='a') turn(-1,0);
  if(k==='arrowright'||k==='d') turn(1,0);
  if(k==='p') toggle();
  if(k==='r') reset();
});

$('btnPause').onclick = toggle;
$('btnRestart').onclick = ()=>reset();
$('padPause').onclick = toggle;

function toggle(){ state.running=!state.running; updateUI() }

// è§¦æ§æŒ‰é’®
document.getElementById('touchCtrls').addEventListener('click',e=>{
  const d = e.target.dataset.d;
  if(d==='up')turn(0,-1); if(d==='down')turn(0,1);
  if(d==='left')turn(-1,0); if(d==='right')turn(1,0);
});
// æ»‘åŠ¨æ‰‹åŠ¿
let touchStart=null;
cv.addEventListener('touchstart',e=>{touchStart = e.touches[0]});
cv.addEventListener('touchmove',e=>{
  if(!touchStart) return;
  const t=e.touches[0]; const dx=t.clientX-touchStart.clientX; const dy=t.clientY-touchStart.clientY;
  if(Math.abs(dx)+Math.abs(dy) > 24){
    if(Math.abs(dx)>Math.abs(dy)) turn(Math.sign(dx),0); else turn(0,Math.sign(dy));
    touchStart=null;
  }
});
cv.addEventListener('touchend',()=>touchStart=null);

// ===== é€»è¾‘æ›´æ–° =====
function step(dt){
  if(!state.running) return;

  state.elapsed += dt;
  const slowBonus = state.freezeTick>0 ? 1.6 : 1; // å‡é€Ÿæ—¶æ”¾æ…¢
  const interval = Math.max(42, (BASE_TICK/ (state.speedMul)) * slowBonus);

  if(state.elapsed < interval) return;
  state.elapsed = 0;
  state.tickCnt++;

  // bonus & slow çš„å¯¿å‘½
  if(state.bonus && --state.bonus.ttl<=0) state.bonus=null;
  if(state.freezeTick>0) state.freezeTick--;

  // èµ°ä¸€æ­¥
  state.dir = state.next;
  const head = {
    x: wrap(state.snake[0].x + state.dir.x, GRID),
    y: wrap(state.snake[0].y + state.dir.y, GRID)
  };

  // æ’è‡ªå·±æˆ–éšœç¢
  if(inSnake(head) || inObst(head)){ return gameOver(); }

  state.snake.unshift(head);

  // åƒä¸œè¥¿ï¼Ÿ
  let ate=false, color='rgba(34,197,94,1)';
  if(eq(head, state.food.pos)){
    ate=true; state.score+=1; color='rgba(34,197,94,1)';
    state.food = spawnFood('normal');
    // éšæœºç”Ÿæˆ bonus/slow
    if(!state.bonus && Math.random()<0.18) state.bonus = spawnFood('bonus');
    if(!state.slow && Math.random()<0.18) state.slow = spawnFood('slow');
  } else if(state.bonus && eq(head, state.bonus.pos)){
    ate=true; state.score+=5; color='rgba(245,158,11,1)';
    state.bonus=null;
  } else if(state.slow && eq(head, state.slow.pos)){
    ate=true; state.score+=1; color='rgba(56,189,248,1)';
    state.slow=null; state.freezeTick = 55; // çº¦ 2~3 ç§’
  }

  if(!ate) state.snake.pop();
  else spawnParticles(head, color);

  // å‡çº§ï¼šæ¯ LVL_STEP åˆ†
  const newLvl = Math.floor(state.score/LVL_STEP)+1;
  if(newLvl>state.level){
    state.level = newLvl;
    state.speedMul = Math.min(MAX_SPEED_MUL, state.speedMul+1);
    addObstacles(2 + Math.min(6, Math.floor(state.level/2)));
  }

  best = Math.max(best, state.score);
  localStorage.setItem('snake_best_rich', best);
  updateUI();
}

function gameOver(){
  state.running=false; updateUI();
  // ç®€æ˜“é—ªçƒ
  for(let i=0;i<GRID;i++) spawnParticles({x:randInt(GRID),y:randInt(GRID)}, 'rgba(239,68,68,1)');
}

// ===== ç»˜åˆ¶ =====
function draw(){
  // èƒŒæ™¯ç½‘æ ¼
  ctx.clearRect(0,0,W,H);
  for(let y=0;y<GRID;y++){
    for(let x=0;x<GRID;x++){
      ctx.strokeStyle = 'rgba(148,163,184,.12)';
      ctx.strokeRect(x*CELL, y*CELL, CELL, CELL);
    }
  }

  // éšœç¢
  state.obstacles.forEach(o=>{
    ctx.fillStyle = '#ef4444';
    roundRect(o.x*CELL+2, o.y*CELL+2, CELL-4, CELL-4, 6, true);
  });

  // é£Ÿç‰©
  drawFood(state.food);
  if(state.bonus) drawFood(state.bonus);
  if(state.slow) drawFood(state.slow);

  // è›‡
  state.snake.forEach((seg,i)=>{
    const color = i===0 ? '#eab308' : rainbow(i, state.snake.length, .95);
    roundRect(seg.x*CELL+2, seg.y*CELL+2, CELL-4, CELL-4, 6, true, color);
  });

  // ç²’å­
  drawParticles();

  // æš‚åœé®ç½©
  if(!state.running){
    ctx.fillStyle='rgba(2,6,23,.6)'; ctx.fillRect(0,0,W,H);
    ctx.fillStyle='#e5e7eb'; ctx.textAlign='center';
    ctx.font='bold 28px system-ui'; ctx.fillText('æš‚åœ / æ¸¸æˆç»“æŸ', W/2, H/2-10);
    ctx.font='14px system-ui'; ctx.fillText('R é‡å¼€ï¼ŒP ç»§ç»­', W/2, H/2+18);
  }
}

function drawFood(f){
  let color = '#22c55e';
  if(f.kind==='bonus') color = '#f59e0b';
  if(f.kind==='slow')  color = '#38bdf8';
  roundRect(f.pos.x*CELL+4, f.pos.y*CELL+4, CELL-8, CELL-8, 8, true, color);
}

function roundRect(x,y,w,h,r,fill=true,color='#fff'){
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);
  ctx.arcTo(x,y,x+w,y,r);
  ctx.closePath();
  ctx.fillStyle = color;
  if(fill) ctx.fill();
}

// ===== ä¸»å¾ªç¯ =====
let last=0;
function loop(ts){
  const dt = ts - last; last = ts;
  step(dt); draw();
  requestAnimationFrame(loop);
}

// å¯åŠ¨
reset();
requestAnimationFrame(loop);

})();
</script>
</body>
</html>
