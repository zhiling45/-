<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>贪吃蛇 · 彩色豪华版 v1.2</title>
<style>
:root{--bg:#0b1220;--fg:#e5e7eb}
*{box-sizing:border-box}
body{margin:0;background:radial-gradient(1000px 600px at 10% -10%, #1d2640 0%, #0b1220 40%, #090f1a 100%);color:var(--fg);
  font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC","Microsoft YaHei",Arial,sans-serif;
  min-height:100vh;display:grid;place-items:center;padding:16px}
.wrap{width:100%;max-width:620px;display:grid;gap:12px}
.top{display:flex;justify-content:space-between;align-items:center;gap:8px}
h1{margin:0;font-size:20px}
.stats{display:flex;gap:8px;flex-wrap:wrap}.pill{border:1px solid #334155;padding:4px 10px;border-radius:999px;background:rgba(17,24,39,.6)}
.btn{border:1px solid #475569;background:#111827;color:var(--fg);padding:8px 12px;border-radius:12px}
.board{position:relative;border:1px solid #334155;border-radius:16px;overflow:hidden;background:#020617}
canvas{width:100%;aspect-ratio:1;display:block;touch-action:none}
.start-mask{
  position:absolute; inset:0; display:grid; place-items:center; background:rgba(2,6,23,.6); backdrop-filter:blur(2px);
}
.start-btn{
  background:#16a34a; border:none; color:white; padding:14px 20px; border-radius:14px; font-weight:700; font-size:16px;
  box-shadow:0 6px 20px rgba(22,163,74,.35);
}
.controls{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.pad{background:#0f172a;border:1px solid #334155;border-radius:12px;padding:16px;text-align:center;font-weight:700}
.pad:active{transform:scale(.98);border-color:#7c3aed}
.legend{display:flex;gap:8px;flex-wrap:wrap;font-size:12px;opacity:.9}
.dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px;vertical-align:-1px}
footer{opacity:.6;text-align:center;font-size:12px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h1>🌈 贪吃蛇 · 彩色豪华版</h1>
      <div>
        <button class="btn" id="btnPause">暂停</button>
        <button class="btn" id="btnRestart">重开</button>
      </div>
    </div>

    <div class="top">
      <div class="stats">
        <div class="pill">分数 <span id="score">0</span></div>
        <div class="pill">最高 <span id="best">0</span></div>
        <div class="pill">等级 <span id="level">1</span></div>
        <div class="pill">速度 <span id="speed">1x</span></div>
      </div>
      <div class="legend">
        <span><i class="dot" style="background:#22c55e"></i>普通</span>
        <span><i class="dot" style="background:#f59e0b"></i>⭐加分</span>
        <span><i class="dot" style="background:#38bdf8"></i>❄减速</span>
        <span><i class="dot" style="background:#ef4444"></i>障碍</span>
      </div>
    </div>

    <div class="board">
      <canvas id="c" width="528" height="528"></canvas>
      <!-- 首次交互启动用的遮罩与按钮 -->
      <div id="startMask" class="start-mask">
        <button id="startBtn" class="start-btn">开始游戏</button>
      </div>
    </div>

    <div class="controls" id="touchCtrls">
      <div></div><button class="pad" data-d="up">↑</button><div></div>
      <button class="pad" data-d="left">←</button>
      <button class="pad" data-d="down">↓</button>
      <button class="pad" data-d="right">→</button>
      <div></div><button class="pad" id="padPause">暂停/继续</button><div></div>
    </div>

    <footer>键盘：↑↓←→ / WASD；P 暂停；R 重开；手机支持滑动</footer>
  </div>

<script>
(()=>{
// ===== 参数 =====
const GRID=24, CELL=22, W=GRID*CELL, H=GRID*CELL;
const BASE=115, STEP=8, MAXMUL=7;
const cv=document.getElementById('c'), ctx=cv.getContext('2d');
const $=id=>document.getElementById(id);
const startMask=$('startMask'), startBtn=$('startBtn');

let best=+localStorage.getItem('snake_best_rich')||0; $('best').textContent=best;
let timer=null;

const rint=n=>(Math.random()*n)|0, eq=(a,b)=>a.x===b.x&&a.y===b.y;
const wrap=(v,max)=>(v+max)%max;
const inArr=(p,arr)=>arr.some(s=>s.x===p.x&&s.y===p.y);

function rb(i,n,a=1){const t=i/n,r=Math.floor(255*Math.abs(Math.sin(Math.PI*t)));
const g=Math.floor(255*Math.abs(Math.sin(Math.PI*(t+.33))));
const b=Math.floor(255*Math.abs(Math.sin(Math.PI*(t+.66))));
return `rgba(${r},${g},${b},${a})`}

const particles=[];
function boom(p,color){
  for(let i=0;i<10;i++) particles.push({x:p.x*CELL+CELL/2,y:p.y*CELL+CELL/2,vx:(Math.random()-.5)*3,vy:(Math.random()-.5)*3,life:18,color});
}
function drawParticles(){
  for(let i=particles.length-1;i>=0;i--){
    const P=particles[i]; P.x+=P.vx; P.y+=P.vy; P.life--;
    const a=(P.life/18).toFixed(2); ctx.fillStyle=P.color.replace('1)',a+')');
    ctx.fillRect(P.x,P.y,3,3); if(P.life<=0) particles.splice(i,1);
  }
}

let st;
function freeSpot(){
  while(true){
    const p={x:rint(GRID),y:rint(GRID)};
    if(!inArr(p,st.snake) && !inArr(p,st.obstacles)) return p;
  }
}
function makeFood(kind='normal'){return {kind,pos:freeSpot(),ttl:kind==='bonus'?600:null}}
function addObs(n){for(let i=0;i<n;i++) st.obstacles.push(freeSpot())}

function reset(){
  st={snake:[{x:12,y:12},{x:11,y:12},{x:10,y:12}],dir:{x:1,y:0},next:{x:1,y:0},
      food:makeFood('normal'),bonus:null,slow:null,obstacles:[],score:0,level:1,speedMul:1,
      freeze:0,running:false}; // 初始不运行，等点击“开始”
  addObs(4); paint(); ui();
}
function ui(){
  $('score').textContent=st.score; $('level').textContent=st.level;
  $('speed').textContent=st.speedMul+'x';
  $('btnPause').textContent = st.running ? '暂停' : '继续';
  $('padPause').textContent = st.running ? '暂停/继续' : '继续/暂停';
}

function startLoop(){
  stopLoop();
  const interval=Math.max(42, (BASE/st.speedMul)*(st.freeze>0?1.6:1));
  timer=setInterval(tick, interval);
}
function stopLoop(){ if(timer){clearInterval(timer); timer=null} }
function startGameOnce(){
  if(st.running) return;
  st.running=true; startMask.style.display='none'; ui(); startLoop();
}

// 输入
function turn(x,y){ if(x===-st.dir.x&&y===-st.dir.y) return; st.next={x,y} }
addEventListener('keydown',e=>{
  const k=e.key.toLowerCase();
  if(k==='arrowup'||k==='w'){turn(0,-1); startGameOnce();}
  if(k==='arrowdown'||k==='s'){turn(0,1);  startGameOnce();}
  if(k==='arrowleft'||k==='a'){turn(-1,0); startGameOnce();}
  if(k==='arrowright'||k==='d'){turn(1,0); startGameOnce();}
  if(k==='p') toggle();
  if(k==='r') reset();
});
$('btnPause').onclick=toggle; $('btnRestart').onclick=()=>{reset(); startMask.style.display='grid'};
$('padPause').onclick=toggle;
$('touchCtrls').addEventListener('click',e=>{
  const d=e.target.dataset.d;
  if(d==='up'){turn(0,-1); startGameOnce();}
  if(d==='down'){turn(0,1); startGameOnce();}
  if(d==='left'){turn(-1,0); startGameOnce();}
  if(d==='right'){turn(1,0); startGameOnce();}
});
startBtn.onclick=()=>startGameOnce();

let tStart=null; cv.addEventListener('touchstart',e=>{tStart=e.touches[0]});
cv.addEventListener('touchmove',e=>{
  if(!tStart) return; const t=e.touches[0],dx=t.clientX-tStart.clientX,dy=t.clientY-tStart.clientY;
  if(Math.abs(dx)+Math.abs(dy)>24){
    if(Math.abs(dx)>Math.abs(dy)) turn(Math.sign(dx),0); else turn(0,Math.sign(dy));
    startGameOnce(); tStart=null;
  }
},{passive:true});
cv.addEventListener('touchend',()=>tStart=null);

function toggle(){ st.running=!st.running; ui(); st.running?startLoop():stopLoop() }

function tick(){
  if(!st.running) return;
  if(st.bonus && --st.bonus.ttl<=0) st.bonus=null;
  if(st.freeze>0) st.freeze--;

  st.dir=st.next;
  const head={x:wrap(st.snake[0].x+st.dir.x,GRID),y:wrap(st.snake[0].y+st.dir.y,GRID)};
  if(inArr(head,st.snake)||inArr(head,st.obstacles)){ gameOver(); return; }
  st.snake.unshift(head);

  let ate=false,color='rgba(34,197,94,1)';
  if(eq(head,st.food.pos)){ ate=true; st.score+=1; st.food=makeFood('normal');
    if(!st.bonus && Math.random()<.18) st.bonus=makeFood('bonus');
    if(!st.slow && Math.random()<.18)  st.slow=makeFood('slow'); }
  else if(st.bonus && eq(head,st.bonus.pos)){ ate=true; st.score+=5; color='rgba(245,158,11,1)'; st.bonus=null; }
  else if(st.slow && eq(head,st.slow.pos)){ ate=true; color='rgba(56,189,248,1)'; st.slow=null; st.freeze=55; }

  if(!ate) st.snake.pop(); else boom(head,color);

  const lv=Math.floor(st.score/STEP)+1;
  if(lv>st.level){ st.level=lv; st.speedMul=Math.min(MAXMUL,st.speedMul+1); addObs(2+Math.min(6,Math.floor(lv/2))); startLoop(); }

  best=Math.max(best,st.score); localStorage.setItem('snake_best_rich',best);
  ui(); paint();
}

function gameOver(){ st.running=false; ui(); stopLoop(); startMask.style.display='grid'; }

function rr(x,y,w,h,r,c){ ctx.beginPath(); ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r);
  ctx.closePath(); ctx.fillStyle=c; ctx.fill(); }

function drawFood(f){ let c='#22c55e'; if(f.kind==='bonus')c='#f59e0b'; if(f.kind==='slow')c='#38bdf8';
  rr(f.pos.x*CELL+4,f.pos.y*CELL+4,CELL-8,CELL-8,8,c); }

function paint(){
  ctx.clearRect(0,0,W,H);
  for(let y=0;y<GRID;y++) for(let x=0;x<GRID;x++){ ctx.strokeStyle='rgba(148,163,184,.12)'; ctx.strokeRect(x*CELL,y*CELL,CELL,CELL); }
  st.obstacles.forEach(o=> rr(o.x*CELL+2,o.y*CELL+2,CELL-4,CELL-4,6,'#ef4444'));
  drawFood(st.food); if(st.bonus)drawFood(st.bonus); if(st.slow)drawFood(st.slow);
  st.snake.forEach((s,i)=> rr(s.x*CELL+2,s.y*CELL+2,CELL-4,CELL-4,6, i? rb(i,st.snake.length,.95): '#eab308'));
  drawParticles();
}

// 启动到“等待开始”状态
reset();
})();
</script>
</body>
</html>
